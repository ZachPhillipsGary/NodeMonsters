// game.js
// ========
"use strict";
module.exports = {
  map: function(size) {
   this.size = size || 70;
   function tile(properties) {
     //constructor
       if (properties.hasOwnProperty("x") && properties.hasOwnProperty("y")) {
           if(properties.x >= 0 && properties.y >= 0) {
             this.x = properties.x || 0;
             this.y = properties.y || 0;
           }
       }
     if (properties.hasOwnProperty("color")) {
         this.color = properties.color || "#ffffff";
     }
     if (properties.hasOwnProperty("kind")) {
       this.kind = null;
       switch (properties.Type) {
         case "floor":
         //floor
           this.kind = 0;
           break;
         default:
         //wall
         this.kind = 1;

       }
     }
     //Construct the list of items and players on the tile
     if (properties.hasOwnProperty("objects")) {
       this.objects =  new Array();
       if (Array.isArray(properties.objects)) {
           for (var i = 0; i < properties.objects.length; i++) {
             this.objects.push(properties.objects[i]);
           }
       }
     }
   }
   tile.prototype.getTile = function () {
    var color = "#ffffff";
    var objectKey = "";
    for (var key in this.objects) {
        color  = this.objects[key];
        objectKey =  key;
    }
    if (color === "#ffffff") {
        color = this.color;
    }
      return {
            "objects":objectKey,
            "color": color
      }
   };
   //create map
  this.mapArray = new Array();
   for (var i = 0; i < size; i++) {
     this.mapArray[i] =  new Array();
     for (var l = 0; l < size; l++) {
       var tileType = 0;
       var colorVal = "#ffffff";
       if ((i === 0) || (l === 0) || (i === this.size-1) || (l === this.size-1) ) {
         tileType = 1;
         colorVal = "#000000";
       }
      this.mapArray[i][l] = new tile({
         "x": i,
         "y": l,
         "color": colorVal,
         "objects": {},
         "kind": tileType
       });
     }
   }
 }
};
module.exports.map.prototype.getAbove = function (x,y) {
/*  if (y > this.mapArray.length) {
    return mapArray[x][0];
  }
  if (y < 0) {
    return mapArray[x][mapArray.length];
  }*/
  return this.mapArray[x][y+1];
};
module.exports.map.prototype.getBelow = function (x,y) {
return this.mapArray[x][y-1];
};
module.exports.map.prototype.getRight = function (x,y) {
return this.mapArray[x+1][y];
};
module.exports.map.prototype.getLeft = function (x,y) {
return this.mapArray[x-1][y];
};
module.exports.map.prototype.getTile = function (x,y) {
return this.mapArray[x][y];
};
module.exports.map.prototype.setTile = function (x,y,element) {
 this.mapArray[x][y] = element;
};
module.exports.map.prototype.setPlayer = function (x,y,player) {
    function getRandomColor() {
     var letters = '0123456789ABCDEF'.split('');
     var color = '#';
     for (var i = 0; i < 6; i++ ) {
         color += letters[Math.floor(Math.random() * 16)];
     }
     return color;
   }
 this.mapArray[x][y].objects[String(player)] = getRandomColor();
};
module.exports.map.prototype.movePlayer = function (x,y,direction,player) {
  console.log(x,y,direction,player);
  console.log(this.mapArray[x][y].objects);
  //first verify that player is on the tile
  if (this.mapArray[x][y].objects.hasOwnProperty(String(player.username))) {
    switch(direction) {
    case "up":
    if( this.mapArray[x][y-1].kind != 1) {
     this.mapArray[x][y-1].objects[String(player.username)] = this.mapArray[x][y].objects[String(player.username)];
     delete this.mapArray[x][y].objects[String(player.username)]; // remove reference to player on previous tile
      player.y--;
   }
        break;
    case "down":
    if( this.mapArray[x][y+1].kind != 1) {
     this.mapArray[x][y+1].objects[String(player.username)] = this.mapArray[x][y].objects[String(player.username)];
     delete this.mapArray[x][y].objects[String(player.username)]; // remove reference to player on previous tile
     player.y++;
   }
        break;
    default:
        
}
  }
    console.log(x,y,direction,player);
};
module.exports.map.prototype.printMap = function() {
var mapVals = new Array();
  for (var i = 0; i < this.mapArray.length; i++) {
    mapVals[i] = [];
      for (var l = 0; l < this.mapArray[i].length; l++) {
    
            mapVals[i][l] = this.mapArray[i][l].getTile();
        
      }
  }
  return mapVals;
};
